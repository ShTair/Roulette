@page "/{Id}"
@inject IJSRuntime JS
@inject NavigationManager Nav
@using System.Text.Json
@using Microsoft.JSInterop
@using System.Collections.Generic
@using System.Linq
@using Roulette.Models
@implements IDisposable

<PageTitle>@selectedConfig - ルーレット</PageTitle>

<div class="text-center config-header">
    <h4>@(string.IsNullOrEmpty(selectedConfig) ? "設定なし" : selectedConfig)</h4>
</div>
<div id="rouletteContainer" class="roulette-container">
    <div class="wheel-shadow">
        <canvas id="rouletteCanvas" width="300" height="300" @onclick="ToggleSpin"></canvas>
    </div>
    <div class="pointer"></div>
    @if (showOverlay)
    {
        <div id="resultOverlay" class="overlay" @onclick="HideOverlay">
            <div id="overlayContent" class="overlay-content" style="@($"background-color:{overlayColor};color:{overlayTextColor};left:{overlayLeft}px;top:{overlayTop}px;")">
                @overlayText
            </div>
        </div>
    }
</div>
<div class="mt-3 text-center">
    <button class="btn btn-primary start-stop-button" @onclick="ToggleSpin" disabled="@((isStopping) || (isSpinning && autoStop))">@(isSpinning ? "ストップ" : "スタート")</button>
</div>
<div class="mt-3 text-center">
    <div class="form-check form-switch d-inline-block">
        <input class="form-check-input" type="checkbox" id="autoStopToggle" @bind="autoStop" @bind:after="OnAutoStopChanged" />
        <label class="form-check-label" for="autoStopToggle">自動ストップ</label>
    </div>
</div>

@if (DisabledItemCount > 0)
{
    <div class="text-center mt-2">
        <button class="btn btn-danger ms-2" @onclick="EnableAllDisabled">非表示の @DisabledItemCount 項目を表示</button>
    </div>
}

<div class="mt-2">
    <ToggleSection Title="当たり回数リスト"
                   HeaderStyle="margin: 0 auto; max-width: 300px; text-align: center;"
                   IsOpen="@showCounts" IsOpenChanged="OnShowCountsChanged">
        <table class="table table-sm count-table" style="--border-color:@borderColor;">
            <thead class="text-center">
                <tr>
                    <th>表示</th>
                    <th>項目</th>
                    <th>回数</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in allItems)
                {
                    <tr style="background-color:@item.Color;color:@item.ForegroundColor">
                        <td class="text-center">
                            <span class="item-state" title="@GetStateTitle(item.State)">@GetStateIcon(item.State)</span>
                        </td>
                        <td>@item.Text</td>
                        <td class="text-end">@item.Count</td>
                    </tr>
                }
            </tbody>
        </table>
    </ToggleSection>
</div>

<div class="text-center mt-2">
    <button class="btn btn-secondary ms-2" @onclick="OpenManage">一覧</button>
    <button class="btn btn-secondary settings-button" @onclick="OpenSettings">設定</button>
</div>

@code {
    [Parameter]
    public string? Id { get; set; }

    private string? currentId;
    private RouletteItem[] items = Array.Empty<RouletteItem>(); // active items
    private RouletteItem[] allItems = Array.Empty<RouletteItem>();
    private int itemMultiplier = 1;
    private bool isSpinning;
    private bool isStopping;
    private bool showOverlay;
    private bool showCounts;
    private double overlayLeft;
    private double overlayTop;
    private string overlayText = string.Empty;
    private string overlayColor = "white";
    private string overlayTextColor = "black";
    private string borderColor = "#808080";
    private DotNetObjectReference<Main>? objRef;
    private string selectedConfig = string.Empty;
    private bool autoAdjustSize = true;
    private bool autoStop = true;
    private int DisabledItemCount => allItems.Count(i => i.State == RouletteItemState.Disabled);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender || currentId != Id)
        {
            currentId = Id;
            var configs = await RouletteConfig.LoadAsync(JS);

            if (string.IsNullOrEmpty(Id))
            {
                Nav.NavigateTo("");
                return;
            }

            var cfg = configs.FirstOrDefault(c => c.Id == Id);
            if (cfg is null)
            {
                Nav.NavigateTo("");
                return;
            }

            allItems = cfg.Items.ToArray();
            itemMultiplier = cfg.ItemMultiplier;
            selectedConfig = cfg.Name;
            autoAdjustSize = cfg.AutoAdjustSize;
            showCounts = cfg.ShowCountList;

            RebuildItems();

            if (items.Length == 0 || allItems.All(i => string.IsNullOrWhiteSpace(i.Text)))
            {
                Nav.NavigateTo($"setting/{Id}");
                return;
            }

            objRef ??= DotNetObjectReference.Create(this);
            var appSettings = await AppSettings.LoadAsync(JS);
            borderColor = appSettings.BorderColor;
            await JS.InvokeVoidAsync("rouletteHelper.initialize", "rouletteCanvas", ItemsForJs(), objRef, appSettings.IdleSpin);
            await JS.InvokeVoidAsync("rouletteHelper.applySettings", appSettings);
            await JS.InvokeVoidAsync("rouletteHelper.setAutoStopEnabled", autoStop);

            StateHasChanged();
        }

    }

    private async Task ToggleSpin()
    {
        if (isStopping)
        {
            return;
        }

        if (isSpinning)
        {
            if (autoStop)
            {
                return;
            }
            isStopping = true;
        }

        isSpinning = !isSpinning;
        await JS.InvokeVoidAsync("rouletteHelper.toggleSpin");
    }

    private async Task EnableAllDisabled()
    {
        foreach (var item in allItems)
        {
            if (item.State == RouletteItemState.Disabled)
            {
                item.State = RouletteItemState.Enabled;
            }
        }
        RebuildItems();
        await SaveCountsAsync();
        var appSettings = await AppSettings.LoadAsync(JS);
        await JS.InvokeVoidAsync("rouletteHelper.initialize", "rouletteCanvas", ItemsForJs(), objRef, appSettings.IdleSpin);
        await JS.InvokeVoidAsync("rouletteHelper.applySettings", appSettings);
        await JS.InvokeVoidAsync("rouletteHelper.setAutoStopEnabled", autoStop);
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnRouletteStopped(int index)
    {
        isStopping = false;
        isSpinning = false;
        if (index >= 0 && index < items.Length)
        {
            var item = items[index];
            overlayText = item.Text;
            overlayColor = item.Color;
            overlayTextColor = item.ForegroundColor;
            var center = await JS.InvokeAsync<double[]>("rouletteHelper.getContainerCenter", "rouletteCanvas");
            if (center?.Length == 2)
            {
                overlayLeft = center[0];
                overlayTop = center[1];
            }
            await Task.Delay(500);
            showOverlay = true;

            if (!string.IsNullOrWhiteSpace(item.Text))
            {
                item.Count++;
                if (item.State == RouletteItemState.Enabled)
                {
                    item.State = RouletteItemState.Disabled;
                    RebuildItems();
                }
                else
                {
                    ApplyWeights();
                }
                await SaveCountsAsync();
            }

            StateHasChanged();
        }

    }

    [JSInvokable]
    public void OnAutoStop()
    {
        isStopping = true;
        isSpinning = false;
        StateHasChanged();
    }

    private void RebuildItems()
    {
        var multiplier = itemMultiplier <= 1 ? 1 : itemMultiplier;
        var active = allItems.Where(i => i.State != RouletteItemState.Disabled).ToList();
        var list = new List<RouletteItem>(active.Count * multiplier);
        for (int i = 0; i < multiplier; i++)
        {
            list.AddRange(active);
        }
        items = list.ToArray();
        ApplyWeights();
    }

    private void ApplyWeights()
    {
        if (items.Length == 0) return;

        if (autoAdjustSize)
        {
            var min = items.Min(i => i.Count);
            foreach (var item in items)
            {
                var count = item.Count;
                item.Size = 1.0 / (count - min + 1);
                item.Weight = item.Size;
            }
        }
        else
        {
            foreach (var item in items)
            {
                item.Weight = item.Size > 0 ? item.Size : 1;
            }
        }
    }

    private async void HideOverlay()
    {
        showOverlay = false;
        var appSettings = await AppSettings.LoadAsync(JS);
        await JS.InvokeVoidAsync("rouletteHelper.initialize", "rouletteCanvas", ItemsForJs(), objRef, appSettings.IdleSpin);
        await JS.InvokeVoidAsync("rouletteHelper.applySettings", appSettings);
    }

    private async Task OnAutoStopChanged()
    {
        await JS.InvokeVoidAsync("rouletteHelper.setAutoStopEnabled", autoStop);
    }

    private async Task OnShowCountsChanged(bool value)
    {
        showCounts = value;
        await SaveCountsAsync();
    }

    private async Task SaveCountsAsync()
    {
        var configs = await RouletteConfig.LoadAsync(JS);
        var cfg = configs.FirstOrDefault(c => c.Id == Id);
        if (cfg is not null)
        {
            cfg.Items = allItems.ToList();
            cfg.ShowCountList = showCounts;
            await RouletteConfig.SaveAsync(JS, configs);
        }
    }

    private static string GetStateIcon(RouletteItemState state) => state switch
    {
        RouletteItemState.Locked => "🔒",
        RouletteItemState.Enabled => "✅",
        RouletteItemState.Disabled => "🚫",
        _ => string.Empty
    };

    private static string GetStateTitle(RouletteItemState state) => state switch
    {
        RouletteItemState.Locked => "🔒表示",
        RouletteItemState.Enabled => "表示",
        RouletteItemState.Disabled => "非表示",
        _ => string.Empty
    };

    public void Dispose()
    {
        _ = JS.InvokeVoidAsync("rouletteHelper.dispose");
        objRef?.Dispose();
    }

    private object[] ItemsForJs()
    {
        return items.Select(i => new { text = i.Text, color = i.Color, weight = i.Weight, textColor = i.ForegroundColor }).ToArray();
    }

    private void OpenSettings()
    {
        Nav.NavigateTo($"setting/{Id}");
    }

    private void OpenManage()
    {
        Nav.NavigateTo("");
    }
}
