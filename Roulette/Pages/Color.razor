@page "/color/{Id?}"
@inject IJSRuntime JS
@inject NavigationManager Nav
@using System.Text.Json
@using System.Collections.Generic
@using System.Linq
@using System
@using Roulette.Models

<PageTitle>色自動割り当て - ルーレット</PageTitle>

<h3>項目の色自動割り当て</h3>

<div class="mb-3">
    <label class="form-label">明度: @lightness.ToString("0.00")</label>
    <input type="range" class="form-range" min="0" max="1" step="0.01" @bind="lightness" @bind:event="oninput" />
</div>

<div class="mb-3">
    <label class="form-label">彩度: @chroma.ToString("0.00")</label>
    <input type="range" class="form-range" min="0" max="0.4" step="0.01" @bind="chroma" @bind:event="oninput" />
</div>

<div class="d-flex mb-3">
    @foreach (var color in previewColors)
    {
        <div class="preview-box me-2" style="background-color:@color"></div>
    }
</div>

<div class="mb-3 d-flex">
    <button class="btn btn-primary" @onclick="AssignEven">均等に割り当て</button>
    <button class="btn btn-secondary ms-2" @onclick="AssignRandom">ランダムに割り当て</button>
    <button class="btn btn-outline-secondary ms-auto" @onclick="Back">戻る</button>
</div>

@code {
    [Parameter]
    public string? Id { get; set; }

    private List<RouletteItem> items = new();
    private List<RouletteConfig> configs = new();
    private RouletteConfig? currentConfig;

    private double _lightness = 0.8;
    private double lightness
    {
        get => _lightness;
        set
        {
            _lightness = value;
            UpdatePreview();
        }
    }

    private double _chroma = 0.1;
    private double chroma
    {
        get => _chroma;
        set
        {
            _chroma = value;
            UpdatePreview();
        }
    }

    private readonly Random rand = new();
    private readonly string[] previewColors = new string[3];

    protected override async Task OnInitializedAsync()
    {
        configs = await RouletteConfig.LoadAsync(JS);

        if (!string.IsNullOrEmpty(Id))
        {
            currentConfig = configs.FirstOrDefault(c => c.Id == Id);
            if (currentConfig is not null)
            {
                items = currentConfig.Items.ToList();
            }
        }
        else
        {
            var json = await JS.InvokeAsync<string?>("localStorage.getItem", "rouletteItems");
            if (!string.IsNullOrEmpty(json))
            {
                items = JsonSerializer.Deserialize<List<RouletteItem>>(json, JsonUtil.WebOptions) ?? new();
            }
        }
        if (items.Count > 0)
        {
            var (l, c, _) = HexToOklch(items[^1].Color);
            _lightness = Math.Clamp(l, 0, 1);
            _chroma = Math.Clamp(c, 0, 0.4);
        }

        UpdatePreview();
    }

    private async Task AssignEven()
    {
        if (items.Count == 0) return;
        for (int i = 0; i < items.Count; i++)
        {
            var hue = 360.0 * i / items.Count;
            items[i].Color = OklchToHex(lightness, chroma, hue);
        }
        await SaveAsync();
        Back();
    }

    private async Task AssignRandom()
    {
        if (items.Count == 0) return;

        var hues = Enumerable.Range(0, items.Count)
            .Select(i => 360.0 * i / items.Count)
            .ToList();

        for (int i = hues.Count - 1; i > 0; i--)
        {
            int j = rand.Next(i + 1);
            (hues[i], hues[j]) = (hues[j], hues[i]);
        }

        for (int i = 0; i < items.Count; i++)
        {
            items[i].Color = OklchToHex(lightness, chroma, hues[i]);
        }

        await SaveAsync();
        Back();
    }

    private void UpdatePreview()
    {
        for (int i = 0; i < previewColors.Length; i++)
        {
            var hue = 360.0 * i / previewColors.Length;
            previewColors[i] = OklchToHex(lightness, chroma, hue);
        }
    }

    private async Task SaveAsync()
    {
        if (currentConfig is not null)
        {
            currentConfig.Items = items;
            await RouletteConfig.SaveAsync(JS, configs);
        }
        else
        {
            var json = JsonSerializer.Serialize(items, JsonUtil.WebOptions);
            await JS.InvokeVoidAsync("localStorage.setItem", "rouletteItems", json);
        }
    }

    private void Back()
    {
        if (string.IsNullOrEmpty(Id))
        {
            Nav.NavigateTo("setting");
        }
        else
        {
            Nav.NavigateTo($"setting/{Id}");
        }
    }

    private static string OklchToHex(double l, double c, double h)
    {
        var hr = Math.PI * h / 180.0;
        var a = Math.Cos(hr) * c;
        var b = Math.Sin(hr) * c;

        var l_ = l + 0.3963377774 * a + 0.2158037573 * b;
        var m_ = l - 0.1055613458 * a - 0.0638541728 * b;
        var s_ = l - 0.0894841775 * a - 1.2914855480 * b;

        var l3 = l_ * l_ * l_;
        var m3 = m_ * m_ * m_;
        var s3 = s_ * s_ * s_;

        var r = +4.0767416621 * l3 - 3.3077115913 * m3 + 0.2309699292 * s3;
        var g = -1.2684380046 * l3 + 2.6097574011 * m3 - 0.3413193965 * s3;
        var b2 = -0.0041960863 * l3 - 0.7034186147 * m3 + 1.7076147010 * s3;

        double srgb(double x) => x <= 0.0031308 ? 12.92 * x : 1.055 * Math.Pow(x, 1.0 / 2.4) - 0.055;

        var rr = srgb(r);
        var gg = srgb(g);
        var bb = srgb(b2);

        int clamp(double v) => (int)Math.Round(Math.Clamp(v, 0, 1) * 255);

        return $"#{clamp(rr):X2}{clamp(gg):X2}{clamp(bb):X2}";
    }

    private static (double l, double c, double h) HexToOklch(string hex)
    {
        if (string.IsNullOrWhiteSpace(hex)) return (0.8, 0.1, 0);
        if (hex.StartsWith('#')) hex = hex[1..];
        if (hex.Length != 6) return (0.8, 0.1, 0);

        var r = Convert.ToInt32(hex.Substring(0, 2), 16) / 255.0;
        var g = Convert.ToInt32(hex.Substring(2, 2), 16) / 255.0;
        var b = Convert.ToInt32(hex.Substring(4, 2), 16) / 255.0;

        double lin(double x) => x <= 0.04045 ? x / 12.92 : Math.Pow((x + 0.055) / 1.055, 2.4);
        r = lin(r); g = lin(g); b = lin(b);

        var l = 0.4122214708 * r + 0.5363325363 * g + 0.0514459929 * b;
        var m = 0.2119034982 * r + 0.6806995451 * g + 0.1073969566 * b;
        var s = 0.0883024619 * r + 0.2817188376 * g + 0.6299787005 * b;

        var l_ = Math.Cbrt(l);
        var m_ = Math.Cbrt(m);
        var s_ = Math.Cbrt(s);

        var L = 0.2104542553 * l_ + 0.7936177850 * m_ - 0.0040720468 * s_;
        var a = 1.9779984951 * l_ - 2.4285922050 * m_ + 0.4505937099 * s_;
        var b2 = 0.0259040371 * l_ + 0.7827717662 * m_ - 0.8086757660 * s_;

        var C = Math.Sqrt(a * a + b2 * b2);
        var H = Math.Atan2(b2, a) * 180.0 / Math.PI;
        if (H < 0) H += 360.0;

        return (L, C, H);
    }
}
